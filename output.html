<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>聚勢成ONE 共耀凱壽</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

  <style>
    :root {
      --bg-color: #000510;
      --neon-cyan: #00ffff;
      --kgi-blue: #00479d;
      --kgi-orange: #f58025;
      --kgi-green: #5cba46;
      --kgi-white: #ffffff;
      --grid-size: min(8.2vh, 8.2vw);
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: white;
      font-family: "Microsoft JhengHei", sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    /* 星空背景 */
    #particles-js {
      position: absolute;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at bottom, #0c2441 0%, #000000 80%);
      z-index: 1;
      overflow: hidden;
      pointer-events: none;
    }
    .warp-star {
      position: absolute;
      width: 4px;
      height: 4px;
      background: var(--neon-cyan);
      border-radius: 50%;
      opacity: 0;
      box-shadow: 0 0 10px var(--neon-cyan);
      animation: warpSpeed var(--duration) linear infinite;
      animation-delay: var(--delay);
    }
    @keyframes warpSpeed {
      0% { opacity: 0; transform: translateY(0) scale(0.5); }
      10% { opacity: 1; }
      100% { opacity: 0; transform: translateY(-100vh) scale(5); height: 100px; }
    }

    .layout-wrapper {
      display: flex;
      width: 100%;
      height: 100%;
      position: relative;
      z-index: 10;
    }

    .main-display {
      flex: 3;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      perspective: 1200px;
      overflow: hidden;
    }

    .title {
      position: absolute;
      top: 3vh;
      width: 100%;
      text-align: center;
      font-size: 3.5rem;
      color: rgba(255, 215, 0, 0.85);
      text-shadow: 0 0 10px rgba(255, 200, 0, 0.9);
      letter-spacing: 12px;
      font-weight: 900;
      z-index: 20;
    }

    /* 建築格子 */
    .building-wrapper {
      transform: rotateX(15deg) translateY(30px);
      transform-style: preserve-3d;
    }
    .building-grid {
      display: grid;
      gap: 0.6vh;
    }
    .piece {
      width: var(--grid-size);
      height: var(--grid-size);
      background: rgba(0, 15, 30, 0.4);
      border: 1px solid rgba(0, 120, 200, 0.2);
      border-radius: 6px;
      box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.6);
    }
    .piece.active {
      background: var(--kgi-orange) !important;
      box-shadow: 0 0 20px #ff9800;
    }
    .spacer {
      width: var(--grid-size);
      height: var(--grid-size);
      background: transparent;
    }

    /* Sidebar */
    .sidebar {
      flex: 1;
      background: rgba(5, 15, 30, 0.85);
      border-left: 3px solid var(--kgi-blue);
      display: flex;
      flex-direction: column;
      padding: 20px 0;
      overflow-y: auto;
      z-index: 50;
    }

    .sidebar-header {
      padding: 20px;
      cursor: pointer;
      text-align: center;
      user-select: none;
      border-bottom: 1px solid rgba(0,255,255,0.4);
    }

    .message-list {
      flex: 1;
      padding: 20px;
    }

    .msg-card {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--kgi-blue);
      border-left: 4px solid var(--kgi-orange);
      padding: 10px;
      margin-bottom: 18px;
      border-radius: 6px;
    }
    .msg-name { color: var(--neon-cyan); font-size: 1rem; }
    .msg-content { font-size: 1.15rem; }

    /* 跑馬燈 */
    .marquee-container {
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: 80;
      pointer-events: none;
    }
    .marquee-item {
      position: absolute;
      white-space: nowrap;
      bottom: -120px;
      font-size: 2.8rem;
      font-weight: bold;
      color: #fff;
      padding: 20px;
      background: rgba(20,20,60,0.8);
      border-radius: 40px;
      animation: flyUp 14s linear forwards;
    }
    @keyframes flyUp {
      0% { bottom: -150px; opacity: 0; }
      100% { bottom: 120%; opacity: 1; }
    }

    /* === 春聯 === */
    .couplet-col {
      position: absolute;
      top: 20vh;
      bottom: 12vh;
      width: 10%;
      display: flex;
      justify-content: center;
      z-index: 200;
    }
    .couplet-left { left: 2vw; }
    .couplet-right { right: 2vw; }

    .couplet {
      writing-mode: vertical-rl;
      text-orientation: upright;
      font-size: 3.6rem;
      line-height: 1.3;
      padding: 26px 18px;
      border: 4px solid gold;
      background: linear-gradient(180deg, #c10f1a, #6a0008);
      border-radius: 12px;
      color: gold;
      font-weight: 900;
      box-shadow: 0 0 35px rgba(255, 200, 0, 0.8);
      white-space: pre;
    }
  </style>
</head>

<body>
  <div id="particles-js"></div>

  <div class="layout-wrapper">
    <div class="main-display" id="displayArea">

      <div class="title" id="mainTitle">聚勢成ONE - 共耀凱壽</div>

      <div class="building-wrapper">
        <div class="building-grid" id="building"></div>
      </div>

      <div class="marquee-container" id="marqueeArea"></div>

      <div class="couplet-col couplet-left" id="coupletLeft"></div>
      <div class="couplet-col couplet-right" id="coupletRight"></div>
    </div>

    <div class="sidebar">
      <div class="sidebar-header" onclick="manualDownloadBackup()">
        <h2 style="margin:0">⚡ 即時能量祝願 ⚡</h2>
      </div>
      <div class="message-list" id="messageList"></div>
    </div>
  </div>

<script>
/* === 星空 === */
function createWarpStars() {
  const container = document.getElementById('particles-js');
  for (let i = 0; i < 120; i++) {
    const star = document.createElement('div');
    star.classList.add('warp-star');
    star.style.left = `${Math.random() * 100}%`;
    star.style.setProperty('--duration', `${Math.random() * 3 + 1}s`);
    star.style.setProperty('--delay', `${Math.random() * -5}s`);
    container.appendChild(star);
  }
}
createWarpStars();

/* === 建築 === */
const buildingMap = [
 [0,0,1,1,1,1,1,0,0],
 [0,1,1,1,1,1,1,1,0],
 [1,1,1,1,1,1,1,1,1],
 [1,1,1,1,1,1,1,1,1],
 [1,1,1,1,1,1,1,1,1],
 [1,1,1,1,1,1,1,1,1],
 [1,1,1,1,1,1,1,1,1],
 [1,1,1,1,1,1,1,1,1],
];

const building = document.getElementById('building');
let pieces = [], totalPieces = 0, filledCount = 0;

function initBuilding(){
  building.innerHTML = '';
  pieces.length = 0;
  filledCount = 0;
  totalPieces = 0;

  building.style.gridTemplateColumns = `repeat(${buildingMap[0].length}, var(--grid-size))`;

  buildingMap.forEach(row => row.forEach(cell => {
    if(cell){
      const div = document.createElement('div');
      div.className = 'piece';
      building.appendChild(div);
      pieces.push(div);
      totalPieces++;
    } else {
      const s = document.createElement('div');
      s.className = 'spacer';
      building.appendChild(s);
    }
  }));
}
initBuilding();

/* === Sidebar & CSV === */
const blessingHistory = [];
let clickCount = 0;
function manualDownloadBackup(){
  clickCount++;
  if(clickCount === 3){
    if(confirm("強制下載紀錄？")) exportToCSV();
    clickCount = 0;
  }
  setTimeout(()=>{ clickCount = 0; }, 2000);
}

function exportToCSV(){
  if(blessingHistory.length === 0){ alert("無資料"); return; }
  let csv = "\uFEFF時間,姓名,內容\n";
  blessingHistory.forEach(i => csv += `${i.time},${i.name},${i.msg}\n`);
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "祝福紀錄.csv";
  a.click();
}

/* === 跑馬燈 === */
function showMarquee(text){
  const area = document.getElementById("marqueeArea");
  const el = document.createElement("div");
  el.className="marquee-item";
  el.innerText=text;
  area.appendChild(el);
  setTimeout(()=>el.remove(), 15000);
}

/* === 左右春聯 === */
function updateCouplet(role, msg){
  const chars = [...msg].join("\n");
  const el = document.createElement("div");
  el.className = "couplet";
  el.innerText = chars;

  if(role === "chairman"){
    document.getElementById("coupletLeft").innerHTML = '';
    document.getElementById("coupletLeft").appendChild(el);
  } else if (role === "gm"){
    document.getElementById("coupletRight").innerHTML = '';
    document.getElementById("coupletRight").appendChild(el);
  }
}

/* Sidebar push */
function addToSidebar(name, msg){
  const list = document.getElementById("messageList");
  const card = document.createElement("div");
  card.className="msg-card";
  card.innerHTML = `<div class="msg-name">${name}</div><div class="msg-content">${msg}</div>`;
  list.prepend(card);
}

/* 處理一般參與者 */
function handleWish(displayName, msg){
  addToSidebar(displayName, msg);
  showMarquee(`${displayName}：${msg}`);

  if(filledCount < totalPieces){
    pieces[filledCount].classList.add('active');
    filledCount++;
  }
}

/* 處理 summary：不跑馬燈、不填格子 */
function handleSummary(role, displayName, msg){
  addToSidebar(`[${role}] ${displayName}`, msg);
  updateCouplet(role, msg);
}

/* === MQTT === */
const broker="broker.emqx.io";
const port=8084;
const topic="kgi_event_2025_live_demo_vtaco";
const client=new Paho.MQTT.Client(broker, port, "disp_"+Date.now());

client.onConnectionLost = () => setTimeout(connectMQTT, 2000);

client.onMessageArrived=function(msg){
  try{
    const data = JSON.parse(msg.payloadString);
    const role = data.role || "participant";
    const type = data.type || "wish";
    const name = data.name || "匿名";
    const office = data.office || "";
    const msgText = data.msg || "";

    const displayName = office ? `${office} / ${name}` : name;

    const now = new Date();
    blessingHistory.push({
      time:`${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`,
      name:displayName, msg:msgText
    });

    if(type === "summary"){
      handleSummary(role, displayName, msgText);
      return;
    }
    handleWish(displayName, msgText);
  } catch(e){
    console.error("解析失敗", e);
  }
};

function connectMQTT(){
  client.connect({ useSSL:true, onSuccess:()=>client.subscribe(topic) });
}
connectMQTT();
</script>
</body>
</html>
