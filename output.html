<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>聚勢成ONE 共創凱壽</title>

  <!-- MQTT -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <!-- ✅ QRCode（前端即時產生） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root {
      --bg-color: #000510;
      --neon-cyan: #00ffff;

      --kgi-blue: #00479d;
      --kgi-orange: #f58025;
      --kgi-green: #5cba46;
      --kgi-white: #ffffff;

      --grid-size: min(8.2vh, 8.2vw);

      /* ✅ 春聯固定字數/格子設定 */
      --couplet-cells: 15;                 /* ✅ 春聯字數 */
      --couplet-text-size: 3rem;           /* 內容字級 */
      --couplet-name-size: 4rem;           /* （保留變數，不一定用得到） */
      --couplet-cell-gap: 0.25rem;         /* 格子間距 */
      --couplet-unroll-duration: 5.5s;     /* ✅ 卷軸展開速度（越大越慢） */
      --couplet-side-inset: 20vw;          /* ✅ 春聯往中間靠的距離（越小越靠中間） */
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: white;
      font-family: "Microsoft JhengHei", sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    #particles-js {
      position: absolute;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at bottom, #0c2441 0%, #000000 80%);
      z-index: 1;
      overflow: hidden;
      pointer-events: none;
    }

    .warp-star {
      position: absolute;
      width: 4px;
      height: 4px;
      background: var(--neon-cyan);
      border-radius: 50%;
      opacity: 0;
      box-shadow: 0 0 10px var(--neon-cyan);
      animation: warpSpeed var(--duration) linear infinite;
      animation-delay: var(--delay);
    }
    @keyframes warpSpeed {
      0% { opacity: 0; transform: translateY(0) scale(0.5); }
      10% { opacity: 1; }
      100% { opacity: 0; transform: translateY(-100vh) scale(5); height: 100px; }
    }

    .layout-wrapper {
      display: flex;
      width: 100%;
      height: 100%;
      position: relative;
      z-index: 10;
    }

    .main-display {
      flex: 3;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      background-image:
        linear-gradient(transparent 50%, rgba(0, 0, 0, 0.5) 50%),
        radial-gradient(transparent, black);
      background-size: 10px 10px, 100% 100%;
      perspective: 1200px;
      perspective-origin: 50% 90%;
      overflow: hidden;
    }

    .title {
      position: absolute;
      top: 2vh;
      width: 100%;
      text-align: center;
      font-size: 5rem;
      font-weight: 900;
      letter-spacing: 18px;
      color: rgba(255, 215, 0, 0.95);
      text-shadow:
        0 0 25px rgba(255, 215, 0, 0.8),
        0 0 45px rgba(255, 150, 0, 0.6),
        0 0 65px rgba(0, 100, 255, 0.6);
      z-index: 200;
      animation: titleGlow 4s ease-in-out infinite;
    }
    @keyframes titleGlow {
      0%, 100% { filter: drop-shadow(0 0 0 rgba(255,215,0,0)); }
      50% { filter: drop-shadow(0 0 15px rgba(255,215,0,0.6)); }
    }

    .building-wrapper {
      position: relative;
      padding: 0;
      border: none;
      box-shadow: none;
      z-index: 10;
      transform: rotateX(15deg) translateY(20px);
      transform-style: preserve-3d;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .building-grid {
      display: grid;
      gap: 0.5vh;
      margin: 0 auto;
    }

    /* ⭐ VIP 星星（五角星） */
    .vip-star {
      position: absolute;
      width: 80px;
      height: 80px;
      background: #ffd700;
      box-shadow: 0 0 35px rgba(255, 215, 0, 1);
      z-index: 160;
      animation: vipStarFly 1.2s ease-out forwards;
      clip-path: polygon(
        50% 0%,
        61% 35%,
        98% 35%,
        68% 57%,
        79% 91%,
        50% 70%,
        21% 91%,
        32% 57%,
        2% 35%,
        39% 35%
      );
    }

    /* ✅ 重要：不再用固定百分比定位星星（改由 JS 對齊春聯欄位中心） */
    /* .vip-star-left { left: 42%; } */
    /* .vip-star-right { left: 54%; } */

    @keyframes vipStarFly {
      0% { top: 100vh; opacity: 0; transform: scale(0.6); }
      30% { opacity: 1; }
      100% { top: 8vh; opacity: 1; transform: scale(1); }
    }

    .piece {
      width: var(--grid-size);
      height: var(--grid-size);
      background-color: rgba(0, 15, 30, 0.55);
      border: 2px solid rgba(0, 180, 255, 0.4);
      border-radius: 4px;
      position: relative;
      box-shadow:
        0 0 8px rgba(100, 180, 255, 0.25),
        inset 0 0 10px rgba(0, 150, 255, 0.15);
      transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
    }

    .piece::after {
      content: "";
      position: absolute;
      width: 140%;
      height: 140%;
      top: -20%;
      left: -20%;
      background: linear-gradient(
        45deg,
        transparent,
        rgba(0,255,255,0.6),
        transparent
      );
      opacity: 0;
      transform: rotate(0deg);
      animation: borderSweep 4s linear infinite;
      pointer-events: none;
    }
    @keyframes borderSweep {
      0%   { opacity: 0; transform: rotate(0deg); }
      40%  { opacity: .3; }
      100% { opacity: 0; transform: rotate(360deg); }
    }

    .piece.active {
      border-color: rgba(100, 255, 255, 1);
      box-shadow:
        0 0 18px rgba(0, 255, 255, 1),
        0 0 30px rgba(0, 180, 255, 0.9),
        inset 0 0 12px rgba(0, 255, 255, 0.5);
      transform: scale(1.12) translateZ(8vh);
      border-width: 2px;
    }

    .piece.dimmed {
      filter: brightness(0.5) saturate(0.9);
      opacity: 0.92;
    }

    .spacer {
      width: var(--grid-size);
      height: var(--grid-size);
      background: transparent;
      pointer-events: none;
    }

    .c-blue   { background: var(--kgi-blue) !important;   box-shadow: 0 0 30px var(--kgi-blue); }
    .c-orange { background: var(--kgi-orange) !important; box-shadow: 0 0 30px var(--kgi-orange); }
    .c-green  { background: var(--kgi-green) !important;  box-shadow: 0 0 30px var(--kgi-green); }
    .c-white  { background: var(--kgi-white) !important;  box-shadow: 0 0 30px #ffffff; }

    .split-diag-orange-blue { background: linear-gradient(45deg, var(--kgi-blue) 50%, var(--kgi-orange) 50%) !important; box-shadow: 0 0 30px var(--kgi-orange); }
    .split-diag-white-blue  { background: linear-gradient(135deg, var(--kgi-white) 50%, var(--kgi-blue) 50%) !important; box-shadow: 0 0 30px var(--kgi-blue); }
    .split-blue-orange-diag { background: linear-gradient(135deg, var(--kgi-blue) 48%, var(--kgi-orange) 52%) !important; }
    .split-blue-green-diag  { background: linear-gradient(45deg, var(--kgi-blue) 48%, var(--kgi-green) 52%) !important; }
    .split-horz-blue-orange { background: linear-gradient(to bottom, var(--kgi-blue) 50%, var(--kgi-orange) 50%) !important; }
    .split-horz-blue-white  { background: linear-gradient(to bottom, var(--kgi-blue) 50%, var(--kgi-white) 50%) !important; }
    .split-vert-orange-white{ background: linear-gradient(to right, var(--kgi-orange) 50%, var(--kgi-white) 50%) !important; }
    .split-vert-orange-blue { background: linear-gradient(to right, var(--kgi-orange) 50%, var(--kgi-blue) 50%) !important; }
    .split-special-center   { background: conic-gradient(from 0deg at 50% 50%, var(--kgi-blue) 0% 25%, var(--kgi-white) 25% 50%, var(--kgi-orange) 50% 100%) !important; box-shadow: 0 0 30px var(--kgi-white); }

    .sidebar {
      flex: 1;
      background: rgba(5, 15, 30, 0.85);
      border-left: 3px solid var(--kgi-blue);
      box-shadow: -20px 0 50px rgba(0, 100, 255, 0.2);
      display: flex;
      flex-direction: column;
      z-index: 50;
      backdrop-filter: blur(20px);
      position: relative;
    }

    .sidebar-header {
      padding: 25px;
      background: linear-gradient(90deg, var(--kgi-blue), transparent);
      border-bottom: 2px solid var(--neon-cyan);
      text-align: center;
      cursor: pointer;
      user-select: none;
    }
    .sidebar-header h2 {
      margin: 0;
      color: #ffffff;
      font-size: 1.8rem;
      letter-spacing: 3px;
      text-shadow: 0 0 15px var(--kgi-orange);
      font-style: italic;
    }

    .message-list {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      scroll-behavior: smooth;
      padding-bottom: 220px;
    }

    .msg-card {
      background: linear-gradient(110deg, rgba(0, 50, 150, 0.3), rgba(0, 0, 0, 0.5));
      border: 1px solid var(--kgi-blue);
      border-left: 5px solid var(--kgi-orange);
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      position: relative;
      overflow: hidden;
      animation: slideInRight 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes slideInRight {
      0% { transform: translateX(30px); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }

    .msg-card.vip-summary {
      border-left-color: gold;
      box-shadow: 0 0 25px rgba(255, 215, 0, 0.9);
      background: radial-gradient(circle at top left, rgba(255, 215, 0, 0.35), rgba(0, 0, 0, 0.9));
    }

    .msg-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -150%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transform: skewX(-20deg);
      animation: cardShine 3s infinite;
    }
    @keyframes cardShine { 0% { left: -150%; } 30%, 100% { left: 150%; } }

    .msg-name {
      color: var(--neon-cyan);
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
    }
    .msg-time { color: #aaa; font-size: 0.8rem; }
    .msg-content { font-size: 1.2rem; text-shadow: 1px 1px 2px black; }

    .marquee-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      pointer-events: none;
      z-index: 100;
    }

    .marquee-item {
      position: absolute;
      white-space: nowrap;
      font-size: 3rem;
      color: #fff;
      text-shadow: 0 0 15px var(--kgi-blue), 0 0 30px var(--neon-cyan);
      font-weight: 900;
      bottom: -100px;
      padding: 25px 50px;
      background: linear-gradient(90deg, var(--kgi-blue), #000);
      border: 3px solid #ffffff;
      border-radius: 60px;
      box-shadow: 0 10px 50px rgba(0, 150, 255, 0.6);
      animation: flyToTop 30s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    }
    @keyframes flyToTop {
      0% { bottom: -150px; opacity: 0; transform: scale(0.5) rotate(-5deg); }
      10% { opacity: 1; transform: scale(1.2) rotate(0deg); }
      20% { transform: scale(1); }
      80% { opacity: 1; }
      100% { bottom: 120%; opacity: 0; transform: scale(1.5) translateY(-100px); }
    }

    /* ---------------- 春聯 ---------------- */
    .vip-column {
      position: absolute;
      top: 15vh;
      bottom: auto;
      width: 12%;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      pointer-events: none;
      z-index: 150;
    }

    .vip-left { left: var(--couplet-side-inset); }
    .vip-right { right: var(--couplet-side-inset); }

    .couplet{
      padding: 16px 12px;
      border: 3px solid gold;
      border-radius: 10px;
      color: gold;
      background: linear-gradient(180deg, #b20000, #5a0000);
      font-weight: 900;
      box-shadow: 0 0 25px rgba(255, 200, 0, 0.8);
      pointer-events: auto;
      position: relative;
      transform-origin: top;
      transform: scaleY(0);
      opacity: 1;
      animation: scrollUnroll var(--couplet-unroll-duration) cubic-bezier(0.2, 0.9, 0.25, 1) forwards;
      overflow: hidden;
      box-sizing: border-box;
    }

    /* ✅ 直式內容：只放「輸入文字」格子 */
    .couplet-inner{
      writing-mode: vertical-rl;
      text-orientation: upright;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .couplet::before{
      content:"";
      position:absolute;
      top:-10px;
      left:-6px;
      right:-6px;
      height:14px;
      border-radius: 10px;
      background: linear-gradient(90deg, #ffd700, #fff1a6, #ffd700);
      box-shadow: 0 0 12px rgba(255,215,0,0.55);
    }

    .couplet::after{
      content:"";
      position:absolute;
      bottom:-10px;
      left:-6px;
      right:-6px;
      height:14px;
      border-radius: 10px;
      background: linear-gradient(90deg, #ffd700, #fff1a6, #ffd700);
      box-shadow: 0 0 12px rgba(255,215,0,0.55);
    }

    @keyframes scrollUnroll{
      0%   { transform: scaleY(0); }
      60%  { transform: scaleY(1.02); }
      100% { transform: scaleY(1); }
    }

    .couplet-cells{
      font-size: var(--couplet-text-size);
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      gap: var(--couplet-cell-gap);
      align-items: center;
    }

    .couplet-cells .cell{
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      white-space: pre;
    }
    .couplet-cells .cell.pad{ opacity: 0.35; }

    /* ✅ 春聯外側稱呼：貼在春聯旁邊（右側），不進入 spring 的 writing-mode */
    .vip-couplet-wrap{
      display: flex;
      align-items: flex-start; /* ✅ 置頂 */
      justify-content: flex-start;
      gap: 10px;
      pointer-events: none;
    }

    .vip-couplet-label{
      pointer-events: none;
      color: gold;
      font-weight: 900;
      text-shadow: 0 0 12px rgba(255,215,0,0.55);

      /* ✅ 改成直式 */
      writing-mode: vertical-rl;
      text-orientation: upright;

      font-size: var(--couplet-text-size);
      line-height: 1;
      margin-top: 6px;
      flex: 0 0 auto;
    }

    .vip-step-btn{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 999;
      padding: 12px 18px;
      border: 2px solid rgba(255,215,0,0.8);
      border-radius: 999px;
      background: rgba(0,0,0,0.55);
      color: gold;
      font-weight: 900;
      letter-spacing: 1px;
      cursor: pointer;
      box-shadow: 0 0 18px rgba(255,215,0,0.35);
    }
    .vip-step-btn:active{ transform: scale(0.98); }
    .vip-step-btn:disabled{
      opacity: 0.6;
      cursor: not-allowed;
    }

    .qr-box{
      position: absolute;
      right: 14px;
      bottom: 14px;
      z-index: 120;
      padding: 12px;
      background: rgba(0,0,0,0.6);
      border: 2px solid rgba(255,215,0,0.85);
      border-radius: 12px;
      box-shadow: 0 0 18px rgba(255,215,0,0.35);
      text-align: center;
      user-select: none;
    }
    .qr-box canvas,
    .qr-box img{
      width: 250px;
      height: 250px;
      display: block;
    }
    .qr-hint{
      margin-top: 8px;
      font-size: 0.9rem;
      color: gold;
      letter-spacing: 1px;
    }
  </style>
</head>

<body>
<div id="particles-js"></div>

<div class="layout-wrapper">
  <div class="main-display" id="displayArea">

    <div class="title" id="mainTitle">聚勢成ONE － 共耀凱壽</div>

    <div class="building-wrapper" id="buildingWrapper">
      <div class="building-grid" id="building"></div>
    </div>

    <div class="marquee-container" id="marqueeArea"></div>

    <div class="vip-column vip-left" id="vipLeft"></div>
    <div class="vip-column vip-right" id="vipRight"></div>
  </div>

  <div class="sidebar">
    <div class="sidebar-header" onclick="manualDownloadBackup()">
      <h2 title="連續點擊三次可強制備份下載">⚡ 即時能量祝願 ⚡</h2>
    </div>

    <div class="message-list" id="messageList"></div>

    <div id="qrBox" class="qr-box">
      <div id="qrCode"></div>
      <div class="qr-hint">掃描加入祝福</div>
    </div>
  </div>
</div>

<button id="vipStepBtn" class="vip-step-btn" onclick="vipNextStep()" style="display:none;">
  ① 變暗
</button>

<script>
/* ------------------------------------------------------------------ */
/* 1. Warp stars */
/* ------------------------------------------------------------------ */
function createWarpStars() {
  const container = document.getElementById('particles-js');
  for (let i = 0; i < 120; i++) {
    const star = document.createElement('div');
    star.classList.add('warp-star');
    star.style.left = `${Math.random() * 100}%`;
    star.style.setProperty('--duration', `${Math.random() * 3 + 1}s`);
    star.style.setProperty('--delay', `${Math.random() * -5}s`);
    container.appendChild(star);
  }
}
createWarpStars();

/* ------------------------------------------------------------------ */
/* ✅ QR Code 初始化 */
/* ------------------------------------------------------------------ */
const QR_TARGET_URL = "https://yu3ek.github.io/KGii/input";

function initQRCode(){
  const qrTarget = document.getElementById("qrCode");
  if (!qrTarget) return;
  qrTarget.innerHTML = "";
  new QRCode(qrTarget, {
    text: QR_TARGET_URL,
    width: 250,
    height: 250,
    colorDark: "#000000",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });
}
initQRCode();

/* ------------------------------------------------------------------ */
/* ✅ 春聯：固定字格工具 */
/* ------------------------------------------------------------------ */
const COUPLET_CELLS = 15;

// 不足補全形空白、超過截斷
function toFixedCells(text, n = COUPLET_CELLS){
  const chars = Array.from((text || "").trim());
  const sliced = chars.slice(0, n);
  while (sliced.length < n) sliced.push("　");
  return sliced;
}

function renderCells(containerEl, chars){
  containerEl.innerHTML = "";
  chars.forEach(ch => {
    const cell = document.createElement("span");
    cell.className = "cell" + (ch === "　" ? " pad" : "");
    cell.textContent = ch;
    containerEl.appendChild(cell);
  });
}

/* ------------------------------------------------------------------ */
/* 2. Building */
/* ------------------------------------------------------------------ */
const buildingMap = [
  [0,0,0,2,0,2,0,0,0],
  [0,0,1,1,1,1,1,0,0],
  [0,1,1,1,1,1,1,1,0],
  [1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1],
  [1,1,1,0,0,0,1,1,1]
];

let totalPieces = 0;
let filledCount = 0;
const building = document.getElementById('building');
const pieces = [];

let buildingFilledTime = null;

// ✅ VIP 手動流程控制
let vipStep = 0;
let vipButtonShown = false;
let gmSummary = null;
let chairmanSummary = null;
const vipBtn = document.getElementById('vipStepBtn');

function initBuilding() {
  building.innerHTML = '';
  pieces.length = 0;
  totalPieces = 0;
  filledCount = 0;

  const cols = buildingMap[0].length;
  building.style.gridTemplateColumns = `repeat(${cols}, var(--grid-size))`;

  buildingMap.forEach((row, rowIndex) => {
    row.forEach((cell, colIndex) => {
      const div = document.createElement('div');
      const colorClass = determineLogoColor(colIndex, rowIndex);
      div.dataset.colorClass = colorClass;
      div.dataset.row = rowIndex;
      div.dataset.col = colIndex;

      if (cell === 1 || cell === 2) {
        div.classList.add('piece');
        pieces.push(div);
        building.appendChild(div);
        totalPieces++;
      } else {
        div.classList.add('spacer');
        building.appendChild(div);
      }
    });
  });
}

function determineLogoColor(col, row) {
  if (col === 4) {
    if (row < 1) return 'c-blue';
    if (row >= 1 && row <= 4) return 'split-vert-orange-blue';
    if (row === 5) return 'split-special-center';
    if (row >= 6 && row <= 9) return 'split-vert-orange-white';
    if (row === 10) return 'c-blue';
  }
  if (row === 5) {
    if (col < 4) return 'c-orange';
    if (col > 4) return 'split-horz-blue-white';
  }
  if (row < 5) {
    if (col < 4) {
      if (col + row <= 3) return 'c-blue';
      if (col + row === 4) return 'split-blue-orange-diag';
      return 'c-orange';
    } else if (col > 4) {
      if ((col - 4) - row >= 1) return 'c-green';
      if ((col - 4) - row === 0) return 'split-blue-green-diag';
      return 'c-blue';
    }
  }
  if (row >= 6) {
    if (row === 6) {
      if (col === 0) return 'split-diag-orange-blue';
      if (col >= 1 && col <= 3) return 'c-orange';
    }
    if (row === 7) {
      if (col === 0) return 'c-blue';
      if (col === 1) return 'split-diag-orange-blue';
      if (col >= 2 && col <= 3) return 'c-orange';
    }
    if (row === 8) {
      if (col <= 1) return 'c-blue';
      if (col === 2) return 'split-diag-orange-blue';
      if (col === 3) return 'c-orange';
    }
    if (row === 9) {
      if (col <= 2) return 'c-blue';
      if (col === 3) return 'split-diag-orange-blue';
    }
    if (row === 10) return 'c-blue';

    if (row === 6) {
      if (col >= 5 && col <= 7) return 'c-white';
      if (col === 8) return 'split-diag-white-blue';
    }
    if (row === 7) {
      if (col >= 5 && col <= 6) return 'c-white';
      if (col === 7) return 'split-diag-white-blue';
      if (col === 8) return 'c-blue';
    }
    if (row === 8) {
      if (col === 5) return 'c-white';
      if (col === 6) return 'split-diag-white-blue';
      if (col >= 7) return 'c-blue';
    }
    if (row === 9) {
      if (col === 5) return 'split-diag-white-blue';
      if (col >= 6) return 'c-blue';
    }
  }
  return 'c-blue';
}

function getRandomEmptyIndex() {
  let bestIndex = -1;
  let bestRow = -1;
  let bestCol = Infinity;

  pieces.forEach((p, index) => {
    if (p.classList.contains('active')) return;
    const row = parseInt(p.dataset.row, 10);
    const col = parseInt(p.dataset.col, 10);

    if (row > bestRow || (row === bestRow && col < bestCol)) {
      bestRow = row;
      bestCol = col;
      bestIndex = index;
    }
  });

  return bestIndex;
}

/* ✅ 只點燈（不寫側欄、不跑馬燈、不寫入祝福紀錄） */
function lightOnePieceOnly() {
  if (filledCount >= totalPieces) return;

  const targetIndex = getRandomEmptyIndex();
  if (targetIndex === -1) return;

  const targetPiece = pieces[targetIndex];
  const colorClass = targetPiece.dataset.colorClass;

  targetPiece.classList.add(colorClass);
  targetPiece.classList.add('active');
  filledCount++;

  if (filledCount >= totalPieces && !buildingFilledTime) {
    buildingFilledTime = Date.now();
    if (!vipButtonShown) {
      vipBtn.style.display = 'block';
      vipBtn.innerText = '① 變暗';
      vipButtonShown = true;
    }
  }
}

/* ------------------------------------------------------------------ */
/* 3. Sidebar and CSV */
/* ------------------------------------------------------------------ */
const blessingHistory = [];
let clickCount = 0;

function addToSidebar(displayName, msg) {
  const list = document.getElementById('messageList');
  const card = document.createElement('div');
  card.classList.add('msg-card');
  const now = new Date();
  card.innerHTML =
    `<div class="msg-name">${displayName}<span class="msg-time">${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}</span></div>
     <div class="msg-content">${msg}</div>`;
  list.insertBefore(card, list.firstChild);
}

function exportToCSV() {
  if (blessingHistory.length === 0) { alert("無資料可下載"); return; }
  let csvContent = "\uFEFF發送時間,通訊處/姓名,祝福內容\n";
  blessingHistory.forEach(item => {
    const cleanName = (item.name || '').replace(/,/g, "，");
    const cleanMsg = (item.msg || '').replace(/,/g, "，");
    csvContent += `${item.time},${cleanName},${cleanMsg}\n`;
  });

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.setAttribute("href", url);
  const timestamp = new Date().toISOString().replace(/[:.]/g, "-").slice(0, 19);
  link.setAttribute("download", `KGI_祝福紀錄_${timestamp}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function manualDownloadBackup() {
  clickCount++;
  if (clickCount === 3) {
    if (confirm("強制下載紀錄？")) exportToCSV();
    clickCount = 0;
  }
  setTimeout(() => { clickCount = 0; }, 2000);
}

/* ------------------------------------------------------------------ */
/* 4. Marquee for participants */
/* ------------------------------------------------------------------ */
const marqueeLanes = [2, 18, 34, 50];
const laneNextAvailable = [0, 0, 0, 0];
const MARQUEE_DURATION_MS = 30000;
let marqueeEnabled = true;

function suspendMarquee() {
  marqueeEnabled = false;
  const container = document.getElementById('marqueeArea');
  if (!container) return;
  container.querySelectorAll('.marquee-item').forEach(el => el.remove());
}

function showMarquee(text) {
  if (!marqueeEnabled) return;

  const container = document.getElementById('marqueeArea');
  const el = document.createElement('div');
  el.classList.add('marquee-item');
  el.innerText = text;

  const colors = ['#fff', '#ffd700', '#7df9ff', '#ffb74d'];
  el.style.borderColor = colors[Math.floor(Math.random() * colors.length)];
  el.style.animationDuration = `${MARQUEE_DURATION_MS / 1000}s`;

  const now = Date.now();
  let chosenLaneIndex = -1;
  const randomIndices = [0, 1, 2, 3].sort(() => Math.random() - 0.5);
  for (let i of randomIndices) {
    if (now >= laneNextAvailable[i]) { chosenLaneIndex = i; break; }
  }
  if (chosenLaneIndex === -1) chosenLaneIndex = Math.floor(Math.random() * marqueeLanes.length);

  el.style.left = marqueeLanes[chosenLaneIndex] + '%';
  laneNextAvailable[chosenLaneIndex] = now + 2500;

  container.appendChild(el);

  const cleanup = () => el.remove();
  el.addEventListener('animationend', cleanup, { once: true });
  setTimeout(cleanup, MARQUEE_DURATION_MS + 800);
}

/* participants handling */
function handleIncoming(displayName, msgText) {
  const now = new Date();
  const timeStr =
    now.getHours().toString().padStart(2, '0') + ':' +
    now.getMinutes().toString().padStart(2, '0') + ':' +
    now.getSeconds().toString().padStart(2, '0');

  blessingHistory.push({ time: timeStr, name: displayName, msg: msgText });
  addToSidebar(displayName, msgText);

  showMarquee(`${displayName}：${msgText}`);

  if (filledCount >= totalPieces) return;

  const targetIndex = getRandomEmptyIndex();
  if (targetIndex === -1) return;

  const targetPiece = pieces[targetIndex];
  const colorClass = targetPiece.dataset.colorClass;
  targetPiece.classList.add(colorClass);
  targetPiece.classList.add('active');
  filledCount++;

  if (filledCount >= totalPieces && !buildingFilledTime) {
    buildingFilledTime = Date.now();
    if (!vipButtonShown) {
      vipBtn.style.display = 'block';
      vipBtn.innerText = '① 變暗';
      vipButtonShown = true;
    }
  }
}

function dimBuilding() {
  pieces.forEach(p => {
    if (p.classList.contains('active')) p.classList.add('dimmed');
  });
}

function undimBuilding() {
  pieces.forEach(p => p.classList.remove('dimmed'));
}

function resetVip() {
  vipStep = 0;
  if (vipBtn) {
    vipBtn.disabled = false;
    vipBtn.innerText = '① 變暗';
    if (buildingFilledTime) vipBtn.style.display = 'block';
  }
}

function vipNextStep() {
  if (!buildingFilledTime) return;

  if (vipStep === 0) {
    suspendMarquee();
    dimBuilding();
    vipStep = 1;
    vipBtn.innerText = '② 總經理星星＋春聯';
    return;
  }

  if (vipStep === 1) {
    if (!gmSummary) { alert('尚未收到總經理訊息（role=gm）。'); return; }
    handleSummaryMessage(gmSummary.role, gmSummary.displayName, gmSummary.msgText);
    vipStep = 2;
    vipBtn.innerText = '③ 董事長星星＋春聯';
    return;
  }

  if (vipStep === 2) {
    if (!chairmanSummary) { alert('尚未收到董事長訊息（role=chairman）。'); return; }
    handleSummaryMessage(chairmanSummary.role, chairmanSummary.displayName, chairmanSummary.msgText);
    vipStep = 3;
    vipBtn.innerText = '完成';
    vipBtn.disabled = true;
    return;
  }
}

/* ------------------------------------------------------------------ */
/* 5. Summary handling (Chairman / GM spring couplets + stars) */
/* ------------------------------------------------------------------ */

/* ✅ 春聯：兩邊都統一「稱呼在右邊」，並用 flex 置頂 */
function showVipCouplet(role, displayName, msgText) {
  const leftCol  = document.getElementById('vipLeft');
  const rightCol = document.getElementById('vipRight');
  const targetCol = (role === 'chairman') ? leftCol : rightCol;
  if (!targetCol) return;

  let nameLabel = '';
  if (role === 'chairman') nameLabel = '董事長：';
  else if (role === 'gm') nameLabel = '總經理：';
  else nameLabel = '管理階層：';

  const wrap = document.createElement("div");
  wrap.className = "vip-couplet-wrap";

  const label = document.createElement("div");
  label.className = "vip-couplet-label";
  label.textContent = nameLabel;

  const couplet = document.createElement("div");
  couplet.classList.add("couplet");

  const inner = document.createElement("div");
  inner.classList.add("couplet-inner");

  const cellsWrap = document.createElement("div");
  cellsWrap.classList.add("couplet-cells");

  const cells = toFixedCells(msgText, COUPLET_CELLS);
  renderCells(cellsWrap, cells);

  inner.appendChild(cellsWrap);
  couplet.appendChild(inner);

  // ✅ 統一：春聯在左、稱呼在右（董事長與總經理都一樣）
  wrap.appendChild(couplet);
  wrap.appendChild(label);

  targetCol.innerHTML = '';
  targetCol.appendChild(wrap);
}

/* ✅ 星星：改成「對齊該側春聯欄位的中心」，確保星星與春聯垂直對準 */
function startVipStar(role, displayName, msgText) {
  const displayArea = document.getElementById('displayArea');
  if (!displayArea) return;

  const leftCol  = document.getElementById('vipLeft');
  const rightCol = document.getElementById('vipRight');
  const targetCol = (role === 'chairman') ? leftCol : rightCol;
  if (!targetCol) return;

  const areaRect = displayArea.getBoundingClientRect();
  const colRect  = targetCol.getBoundingClientRect();
  const centerX  = (colRect.left - areaRect.left) + (colRect.width / 2);

  const star = document.createElement('div');
  star.classList.add('vip-star');

  const STAR_SIZE = 80; // 跟 CSS 的 vip-star 寬高一致
  star.style.left = `${centerX - (STAR_SIZE / 2)}px`;

  displayArea.appendChild(star);

  star.addEventListener('animationend', () => {
    showVipCouplet(role, displayName, msgText);
  }, { once: true });
}

function handleSummaryMessage(role, displayName, msgText) {
  suspendMarquee();

  const now = new Date();
  const timeStr =
    now.getHours().toString().padStart(2, '0') + ':' +
    now.getMinutes().toString().padStart(2, '0') + ':' +
    now.getSeconds().toString().padStart(2, '0');

  const roleLabel =
    role === 'chairman' ? '董事長' :
    role === 'gm'       ? '總經理' :
                          '管理階層';

  blessingHistory.push({ time: timeStr, name: `${displayName}`, msg: msgText });

  const list = document.getElementById('messageList');
  const card = document.createElement('div');
  card.classList.add('msg-card', 'vip-summary');
  card.innerHTML =
    `<div class="msg-name">
       <span>${roleLabel}</span>
       <span class="msg-time">${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}</span>
     </div>
     <div class="msg-content">${msgText}</div>`;
  list.insertBefore(card, list.firstChild);

  startVipStar(role, displayName, msgText);
}

/* ------------------------------------------------------------------ */
/* 6. MQTT */
/* ------------------------------------------------------------------ */
const broker = "broker.emqx.io";
const port = 8084;
const topic = "kgi_event_2025_live_demo_vtaco";
const controlTopic = topic + "_control";

const clientID = "monitor_" + new Date().getTime();
const client = new Paho.MQTT.Client(broker, port, clientID);

client.onConnectionLost = function () {
  setTimeout(connectMQTT, 2000);
};

client.onMessageArrived = function (msg) {
  let data;
  try {
    data = JSON.parse(msg.payloadString);
  } catch (e) {
    console.error("訊息解析失敗(JSON)", e);
    return;
  }

  const isControlTopic = (msg.destinationName === controlTopic);
  const type = String(data.type || "").trim();
  const action = String(data.action || data.cmd || "").trim();

  if (isControlTopic || type === "vip_control") {
    switch (action) {
      case "dim_building":
        suspendMarquee();
        dimBuilding();
        if (vipStep === 0) {
          vipStep = 1;
          if (vipBtn && !vipBtn.disabled) vipBtn.innerText = '② 總經理星星＋春聯';
        }
        break;

      case "play_gm":
        if (!gmSummary) { alert('尚未收到總經理訊息（role=gm）。'); break; }
        handleSummaryMessage(gmSummary.role, gmSummary.displayName, gmSummary.msgText);
        if (vipStep < 2) {
          vipStep = 2;
          if (vipBtn && !vipBtn.disabled) vipBtn.innerText = '③ 董事長星星＋春聯';
        }
        break;

      case "play_chairman":
        if (!chairmanSummary) { alert('尚未收到董事長訊息（role=chairman）。'); break; }
        handleSummaryMessage(chairmanSummary.role, chairmanSummary.displayName, chairmanSummary.msgText);
        vipStep = 3;
        if (vipBtn) {
          vipBtn.innerText = '完成';
          vipBtn.disabled = true;
        }
        break;

      case "undim_building":
        undimBuilding();
        break;

      case "reset_vip":
        resetVip();
        break;

      case "next_step":
        vipNextStep();
        break;

      /* ✅ 控制台純點燈（不送祝福內容） */
      case "light_one":
        lightOnePieceOnly();
        break;

      default:
        console.warn("Unknown control action:", action);
    }
    return;
  }

  try {
    const office = (data.office || "").trim();
    const name = (data.name || "").trim();
    const msgText = (data.msg || "").trim();
    const role = (data.role || "participant").trim();
    const msgType = (data.type || "wish").trim();

    if (!msgText) return;

    const displayName = office
      ? `${office} / ${name}`
      : (name || (data.displayName || "匿名"));

    if (msgType === "summary") {
      const item = { role, displayName, msgText, receivedAt: Date.now() };
      if (role === "gm") gmSummary = item;
      if (role === "chairman") chairmanSummary = item;
    } else {
      handleIncoming(displayName, msgText);
    }
  } catch (e) {
    console.error("訊息處理失敗", e);
  }
};

function connectMQTT() {
  client.connect({
    useSSL: true,
    onSuccess: function () {
      client.subscribe(topic);
      client.subscribe(controlTopic);
    },
    onFailure: function () {}
  });
}

initBuilding();
connectMQTT();
</script>

</body>
</html>
